<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta content="address=no" name="format-detection">
    <meta content="origin" name="referrer">
    <title>游戏匹配</title>
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"
        crossorigin="anonymous">
    <style>
        [v-cloak] {
            visibility: hidden;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <div class="d-flex justify-content-center mt-1">
            <label type="button" class="btn btn-sm btn-info mx-2 position-relative overflow-hidden">
                <input type="file" ref="file" accept=".json" @change="onImport"
                    class="position-absolute w-25 h-25 invisible" />
                <i class="bi bi-upload"></i>
                导入</label>
            <label type="button" class="btn btn-sm btn-secondary mx-2" @click.prevent="onExport">
                <i class="bi bi-download"></i>
                导出</label>
        </div>
        <div class="d-flex justify-content-center flex-wrap">
            <div class="mr-md-5 mt-2">
                <v-list :list="leftList" ref="left" @change="onLeftChange"></v-list>
            </div>
            <div class="ml-md-5 mt-2">
                <v-list :list="rightList" ref="right" @change="onRightChange"></v-list>
            </div>
        </div>
        <div class="d-flex justify-content-center mb-3">
            <button type="button" class="btn btn-sm btn-primary mx-2" @click.prevent="match3v3">3 V 3</button>
            <button type="button" class="btn btn-sm btn-success mx-2" @click.prevent="match5v5">5 V 5</button>
            <button type="button" class="btn btn-sm btn-warning mx-2" @click.prevent="reset">重置</button>
        </div>
        <div v-if="queueList.length" class="d-flex justify-content-center align-items-start flex-wrap">
            <ul v-for="(queue,index) in queueList"
                class="list-unstyled text-center border border-success rounded overflow-hidden mt-2 mx-2">
                <li class="px-3 py-1" :style="{backgroundColor:getQueueColor(index)}" aria-current="true">队伍
                    {{index+1}}</li>
                <li class="px-3 py-1 border-top border-success" v-for="row in queue">{{row.ID}}({{row.Job}})</li>
            </ul>

            <ul v-if="otherList.length"
                class="list-unstyled text-center border border-danger rounded overflow-hidden mt-2 mx-2">
                <li class="px-3 py-1 text-danger" aria-current="true">轮空</li>
                <li class="px-3 py-1 border-top border-danger" v-for="row in otherList">{{row.ID}}({{row.Job}})</li>
            </ul>
        </div>
    </div>
    <script type="text/template" id="template-list">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">游戏ID</th>
                    <th scope="col">职业心法</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(row,index) in rows" :style="{backgroundColor:getRowColor(row.ID)}">
                    <td style="white-space: nowrap;">
                        <div class="btn btn-sm rounded-circle text-primary" @click="add(index)"><i class="bi bi-plus-circle-fill"></i></div>
                        <div class="btn btn-sm rounded-circle text-danger" @click="remove(index)"><i class="bi bi-trash-fill"></i></div>
                    </td>
                    <td :class={'border-primary':matchMap.has(row.ID)} ><input type="text" class="form-control form-control-sm" v-model="row.ID" @change="emitChange"/></td>
                    <td><input type="text" class="form-control form-control-sm" v-model="row.Job" @change="emitChange" /></td>
                </tr>
            </tbody>
        </table>
        <!-- <div v-if="alert" class="alert alert-danger" role="alert">{{alert}}</div> -->
    </script>
</body>
<script src="https://unpkg.com/vue@next"></script>
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<script>
    const db = new Dexie('match');
    db.version(1).stores({
        leftList: 'ID',
        rightList: 'ID',
    });

    function readJsonFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsText(file);
            reader.onload = function () {
                resolve(JSON.parse(reader.result))
            };

            reader.onerror = reject
        })
    }

    function randomInt(start, end) {
        return parseInt(Math.random() * (end - start + 1) + start, 10)
    }

    const colorList = ["#9e9e9e", "#ff9800", "#ffc107", "#795548", "#ffeb3b", "#cddc39", "#4caf50", "#00bcd4", "#03a9f4", "#9c27b0"];
</script>
<script>
    const vApp = Vue.createApp({
        data() {
            return {
                leftList: [],
                rightList: [],
                colorList,
                queueList: []
            }
        },
        computed: {
            otherList() {
                if (this.queueList.length) {
                    const set = new Set();
                    this.queueList.forEach(list => list.forEach(e => set.add(e.ID)));
                    return [...this.leftList.filter(e => e.ID.trim() && !set.has(e.ID)), ...this.rightList.filter(e => e.ID.trim() && !set.has(e.ID))]
                }
                return []
            }
        },
        async mounted() {
            this.leftList = await db.leftList.toArray();
            this.rightList = await db.rightList.toArray();
            this.reset();
        },
        methods: {
            match3v3() {
                if(this.queueList.length){
                    return
                }
                while (this.match(1, 2)) { }
            },
            match5v5() {
                if(this.queueList.length){
                    return
                }
                while (this.match(2, 3)) { }
            },
            match(left, right) {
                const leftMatchs = this.$refs.left.match(left);
                if (!leftMatchs) {
                    return
                }
                const rightMatchs = this.$refs.right.match(right);
                if (!rightMatchs) {
                    return
                }
                this.$refs.left.matchLog(leftMatchs);
                this.$refs.right.matchLog(rightMatchs);
                this.queueList.push([...leftMatchs, ...rightMatchs]);
                return true
            },
            onImport(e) {
                const target = e.target;
                readJsonFile(target.files[0]).then((json) => {
                    const data = JSON.parse(JSON.stringify(json));
                    if (json.leftList) {
                        this.leftList = json.leftList;
                        this.onLeftChange(data.leftList);
                    }
                    if (json.rightList) {
                        this.rightList = json.rightList;
                        this.onRightChange(data.rightList);
                    }
                }).catch(() => {

                });
                target.value = "";
            },
            onExport() {
                const file = new File([JSON.stringify({
                    leftList: this.$refs.left.getPlainData(),
                    rightList: this.$refs.right.getPlainData()
                }, null, 2)], 'match.txt', { type: 'application/json' });
                const url = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.href = url;
                a.download = `游戏匹配${new Date().toLocaleString()}.json`;
                a.click();
                requestAnimationFrame(() => {
                    URL.revokeObjectURL(url)
                })
            },
            reset() {
                this.$refs.left.reset();
                this.$refs.right.reset();
                this.queueList.length = 0;
            },
            async onLeftChange(rows) {
                await db.leftList.clear();
                rows.length && db.leftList.bulkAdd(rows);
            },
            async onRightChange(rows) {
                await db.rightList.clear();
                rows.length && db.rightList.bulkAdd(rows);
            },
            getQueueColor(colorIndex) {
                return colorList[colorIndex % colorList.length]
            }
        }
    });

    vApp.component('v-list', {
        props: {
            list: {
                default: (() => [])
            }
        },
        emits: ["change"],
        mounted() {
            this.setRows(this.list)
        },
        watch: {
            list(val) {
                this.setRows(val)
            }
        },
        data() {
            return {
                rows: [],
                alert: "",
                matchColor: 0,
                matchMap: new Map()
            }
        },
        methods: {
            getRowColor(ID) {
                const colorIndex = this.matchMap.get(ID);
                if (colorIndex > -1) {
                    return colorList[colorIndex % colorList.length]
                }
                return
            },
            setRows(list) {
                this.rows = list;
                this.rows.push(this.gen());
            },
            gen() {
                return { ID: "", Job: "" }
            },
            add(index) {
                this.rows.splice(index + 1, 0, this.gen());
                this.emitChange()
            },
            remove(index) {
                this.rows.splice(index, 1);
                this.emitChange()
            },
            emitChange() {
                this.$emit("change", this.getPlainData())
            },
            reset() {
                this.matchColor = 0;
                this.alert = "";
                this.matchMap = new Map();
            },
            match(n) {
                const list = this.getMatchData();
                if (list.length - this.matchMap.size < n) {
                    this.alert = "剩余 ID 不足";
                    return
                }
                const canMatch = list.filter(e => !this.matchMap.has(e.ID));
                return this.getRandomData(canMatch, n);
            },
            matchLog(matchList) {
                const colorIndex = this.matchColor++;
                matchList.forEach(e => this.matchMap.set(e.ID, colorIndex));
            },
            getPlainData() {
                return this.rows.map(a => {
                    return {
                        ID: a.ID.trim(),
                        Job: a.Job.trim()
                    }
                }).filter(a => a.ID || a.Job)
            },
            getMatchData() {
                return this.getPlainData().filter(a => a.ID)
            },
            getRandomData(rows, n) {
                const copyRows = rows.slice();
                const data = [];
                for (let i = 0, max = rows.length - 1; i < n; i++) {
                    data.push(copyRows.splice(randomInt(0, max), 1)[0])
                    max--;
                }
                return data
            }
        },
        template: document.getElementById('template-list').innerHTML
    });

    vApp.mount('#app')
</script>

</html>